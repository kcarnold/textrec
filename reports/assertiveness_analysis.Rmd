---
title: "Suggestion Assertiveness Analysis"
author: "Kenneth C. Arnold"
date: "9/18/2019"
output: html_document
---

The Transparent Statistics guide, especially the [exemplars](https://transparentstats.github.io/guidelines/effectsize.html#effectsize_exemplar_within), was very helpful

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(readr)
library(tidyverse)

# Modeling
library(lme4)
library(lmerTest)
library(car)
library(afex)
library(optimx)
library(papaja) # devtools::install_github("crsh/papaja")
library("emmeans")
library("ARTool")

# Plotting
library("cowplot")
library("ggbeeswarm")

afex::set_sum_contrasts()

## See vignette("afex_mixed_example") for why "asymptotic".
# emm_options(lmer.df = "asymptotic") # also possible: 'satterthwaite', 'kenward-roger'
emm_options(lmer.df="kenward-roger") # slower, but needed for post-hoc tests to make sense.

```

```{r read-data, include=FALSE}
# We need to set the stimulus (image) columns to chars because they otherwise look like numbers.
allData <- read_csv(
  "../data/analyzed/combined_data.csv",
  col_types = cols(
    stimulus = col_character(),
    stimulus_order = col_character()
  ));
stop_for_problems(allData)

allData$recsVisible <- allData$condition != "norecs";
```

```{r munge-data, include=FALSE}
# Exclude bad participants.
data <- subset(allData, (participant != "pr5hff") & (participant != "7q253f"))

# Use only the "Gated" study.
data <- subset(data, experiment == "gc1")

# Set appropriate columns as nominal factors
data$experiment <- factor(data$experiment)
data$block <- factor(data$block)
#data$idx <- factor(data$idx)
#data$idx_in_block <- factor(data$idx_in_block)
data$participant <- factor(data$participant)
data$steppedBack <- factor(data$steppedBack)
data$condition_order <- factor(data$condition_order)
data$stimulus <- factor(data$stimulus)
data$stimulus_order <- factor(data$stimulus_order)

# Name the conditions.
data$condition <- recode_factor(data$condition, "norecs"="Intro.", "gated"="Ambi.", "standard"="Extra.")
data$condition <- factor(data$condition, levels = c("Extra.", "Ambi.", "Intro."))

# (stuff that's useful if we go back and use Contextual)
data$study <- recode_factor(data$experiment, "gc1"="gated", "spec1"="contextual", "spec2"="contextual")
#data$condition_order_2 <- factor(gsub("contextual", "manip", sub("gated", "manip", data$condition_order)))

# Compute derived data.
data$itpw <- data$corrected_tapstotype_standard / data$num_words
data$itpw_log <- log(data$itpw)
data$itpw_gated <- data$corrected_tapstotype_gated / data$num_words
data$mean_rarity <- 1 - (data$mean_log_freq / 7)
data$total_nll <- -data$logprob_unconditional * data$num_words
data$tapsPerSec <- data$num_taps / data$seconds_spent_typing
data$anyErrors <- factor(data$uncorrected_errors != 0)
data$anyADJ = factor(data$ADJ != 0)

data$num_predictable = data$corrected_bow_recs_idealuse_standard
data$frac_predictable = data$corrected_bow_recs_idealuse_standard / data$num_words

#data$num_not_recced = data$corrected_bow_recs_offered_standard - data$corrected_bow_recs_idealuse_standard
#data$frac_not_recced = 1 - data$corrected_bow_recs_idealuse_standard / data$corrected_bow_recs_offered_standard

#data <- data %>% group_by(participant) %>% mutate(mean_relevant_use_frac=mean(relevant_use_frac, na.rm=T)) %>% ungroup()
#data$rec_use_bin <- factor(ntile(data$mean_relevant_use_frac, 2))

vars.to.summarize <- list(
  "num_words"="Number of words written",
  "itpw" = "Ideal Taps per Word (ITPW)",
  "itpw_log" = "log(ITPW)",
  "itpw_gated" = "ITPW in Gated",
  "corrected_tapstotype_standard" = "Total taps to type",
  "num_chars" = "Number of characters",
  "num_colors" = "Number of colors used",
  "mean_rarity"="Mean word rarity (inverse log frequency)",
  "total_rarity"="Total rarity of words used",
  "total_nll"="Total NLL under language model",
  "ADJ" = "Fraction of adjectives",
  "NOUN" = "Fraction of nouns",
  "pos_count_ADJ" = "Number of adjectives",
  "pos_count_NOUN" = "Number of nouns",
  "pos_count_VERB" = "Number of verbs",
  "num_predictable" = "Number of predictable words",
  "frac_predictable" = "Fraction of words that were predictable",
  "relevant_use_frac" = "Fraction of relevant predictions that were used",
  #  "progressive_tense" = "Progressive tense used?",
  "characters_per_sec"="Characters per Second",
  "tapsPerSec" = "Taps per Second",
  "TLX_sum"="Total cognitive load (TLX)",
  "physical"="Physical load (TLX)",
  "mental"="Mental load (TLX)"
)


expLevel <- data %>%
  group_by(experiment, condition_order, participant, age, chars_per_sec_norecs_mean, steppedBack, gender, use_predictive) %>%
  summarise(
    characters_per_sec_mean = mean(characters_per_sec),
    rec_use_per_seen_mean=mean(rec_use_per_seen, na.rm=TRUE))

expLevel$high_prediction_user <- factor(ntile(expLevel$rec_use_per_seen_mean, 2))
expLevel$speed_bin <- factor(ntile(expLevel$chars_per_sec_norecs_mean, 3))

data <- left_join(data, expLevel, copy=TRUE)

blockLevel <- data %>%
  group_by(experiment, participant, block, condition, condition_order, stimulus_order, steppedBack, high_prediction_user, speed_bin, age, chars_per_sec_norecs_mean) %>%
  summarise_at(names(vars.to.summarize), mean)


longForm <- data %>%
  select(experiment, participant, condition, block, idx, idx_in_block, steppedBack, high_prediction_user, !!!names(vars.to.summarize)) %>%
  gather(measure, value, !!!names(vars.to.summarize)) %>%
  mutate(measure=dplyr::recode(measure, !!!vars.to.summarize))

```

```{r}
if (FALSE) {
data %>%
  group_by(participant, condition) %>% 
  summarise(num_predictable=mean(num_predictable)) %>% 
  ggplot() +
    aes(y=num_predictable_words, x=condition, group=participant) +
    geom_point() +
    facet_wrap(~participant) +
    theme_bw()
}
```

```{r}
dataMinusImgMean <- data %>%
  group_by(stimulus) %>% 
  mutate(
    num_predictable = num_predictable - mean(num_predictable),
    frac_predictable = frac_predictable - mean(frac_predictable)
   );
blockLevel <- dataMinusImgMean %>% 
  group_by(participant, stimulus) %>% 
  summarise(num_predictable=mean(num_predictable))
```

```{r}
labeledBar <- list(
  stat_summary(geom="bar", fun.y=mean, position="dodge"),
    stat_summary(geom="errorbar", fun.data=mean_se, position=position_dodge(width=.9), width=.4),
    scale_y_continuous(expand=expand_scale(mult=c(0,.05))), # remove the extra spacing at 0
    stat_summary(geom="text", fun.y=mean,
                 aes(label=sprintf("%1.2f", ..y..)),
                 position=position_dodge(width=.9),
                 hjust="middle", vjust="bottom"))
```

```{r num_predictable}
dataMinusImgMean %>% ggplot(aes(x=condition, y=num_predictable)) + labeledBar
```

```{r frac_predictable}
dataMinusImgMean %>% ggplot(aes(x=condition, y=frac_predictable)) + labeledBar
```

```{r}
results <- afex::aov_ez(
  data=dataMinusImgMean,
  id="participant", # subject identifier
  dv="num_predictable", # outcome
  within=c('condition'),
  between=NULL,
  fun_aggregate = mean,
  anova_table = list(es='ges'));

results
```

```{r}
  #select(-`Pr(>F)`) # no need to show p-values
  
results$anova_table %>% as_tibble(rownames = "effect")
```
